<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// Only run this on current month
var colors =  {{site.data.colors | jsonify}}
Papa.parse("@KARTHIK; change this to a live sheet URL", {
    download: true,
    header: true,
    complete: function (results, file) {
    const leaderboard = results.data.filter(function (row) {
        if (row["Team Name"] == "")
        return false;
        else
        return true
    }).map(function (row) {

        return {
        name: row["Team Name"],
        size: row["Team Size"],
        time: row["Start Time"],
        end: row["End Time"],
        duration: row["Time"]
        }
    })

    // target the table element in which to add one div for each team
    const main = d3.select("table");

    // for each team add one table row
    // ! add a class to the row to differentiate the rows from the existing one
    // otherwise the select method would target the existing one and include one row less than the required amount
    const teams = main
        .selectAll("tr.team")
        .data(leaderboard)
        .enter()
        .append("tr")
        .attr("class", "team");

    // in each row add the information specified by the dataset in td elements
    // specify a class to style the elements differently with CSS

    // position using the index of the data points
    teams
        .append("td")
        .text((d, i) => i + 1)
        .attr("class", "position");

    // name followed by the team
    teams
        .append("td")
        // include the last name in a separate element to style it differently
        // include the team also in another element for the same reason
        .html(({ name, size }) => `${name} <span>${size} players</span>`)
        // include a border with the color matching the team
        .style("border-left", ({ name }) => {
        // find the color using the string value found in d.team
        // ! if the string value has a space, camelCase the value
        const idx =
            Math.abs(
            Array.from(name).reduce(
                (hash, char) => 0 | (31 * hash + char.charCodeAt(0)),
                0
            )
            ) % colors.length;
        const color = colors[idx];
        return `4px solid ${color}`;
        })
        .attr("class", "team");

    // time
    teams
        .append("td")
        .attr("class", "time")
        .append("span")
        .text(({ time }) => {
        if (time.toLowerCase() == "dnf") {
            return time;
        }
        return `${time}pm`;
        });
    // end
    teams
        .append("td")
        .attr("class", ({ duration }) => {
        if (duration.toLowerCase() == "dnf") {
            return "";
        }
        return `time`;
        })
        .append("span")
        .text(({ duration }) => {
        if (duration.toLowerCase() == "dnf") {
            return "-";
        }
        return `${duration.replace(":","h")}m`;
        });
    }
})

</script>
